{% extends 'base.html' %}
{% block content %}
    {% load static %}

    <script>
        var v_status;
        var missing_critical_info = false;

        function changeStatus(status){
            var domainselect = leadselect = pomselect = null;
            if (document.getElementById("domainselect") != null){
                domainselect = document.getElementById("domainselect").value;
                leadselect = document.getElementById("leadselect").value;
                pomselect = document.getElementById("pomselect").value;
                if(document.getElementById("domainselect").value.length && document.getElementById("leadselect").value.length && document.getElementById("pomselect").value.length){
                    missing_critical_info = false;
                }
            }
            if (status == 'SUBMITTED' && missing_critical_info){
                alert("Please update PoM, Domain and Domain Lead info to submit this request.");
                return;
            }

            $("#rfs_status").val(status);
            if(document.forms["initRFS"].reportValidity()){
                $("input").prop('disabled', false);
                formChanged = false;
                $("#initRFS").submit();
            }
        }

        function changeStatus_comment(status){
            v_status = status;
            $("#comment_div").show();
        }

        function updateComment(){
            $("#rfs_status_comment").val($("#comment_text").val());
            changeStatus(v_status);
        }

        const months = [
          'Jan',
          'Feb',
          'Mar',
          'Apr',
          'May',
          'Jun',
          'Jul',
          'Aug',
          'Sep',
          'Oct',
          'Nov',
          'Dec'
        ];

        {% if rfs_request_data.rfs_request_id %}
           var rfs_request_id = {{rfs_request_data.rfs_request_id}};
           var link = '{{rfs_request_data.link}}';
        {% else %}
            var rfs_request_id = null;
            var link = null;
        {% endif %}

        $(document).ready(function() {
            $('#approvals').hide();
            $('#collapse').click(function(){
                $('#approvals').slideToggle('slow');
            });
            {% if rfs_request_data.rfs_request_id %}
            $.ajax({
                url: "/rfs/auditor/",
                type: "post", //send it through get method
                data: {'rfs_request_ids': link},
                success: function(response) {
                console.log(response);
                results = response.results[0].results;
                let findings = 0
                try {
                    if (results.result_estimates_resources_hrs.est_totals_hrs != results.result_estimates_resources_hrs.res_load_total_hrs){
                        document.getElementById('result_estimates_resources_hrs').innerHTML = '<img src="{% static 'images/audit_fail.png' %}">';
                        document.getElementById('result_estimates_resources_hrs').innerHTML += ' ' + results.result_estimates_resources_hrs.res_load_total_hrs + ' Hrs. vs ';
                        document.getElementById('result_estimates_resources_hrs').innerHTML += ' ' + results.result_estimates_resources_hrs.est_totals_hrs + ' Hrs.';
                        findings++;
                    }
                    if (results.result_critical_info[0].pom == null || results.result_critical_info[0].qa_coe_lead == null || results.result_critical_info[0].domain_id == null){
                        document.getElementById('result_critical_info').innerHTML = '<img src="{% static 'images/audit_fail.png' %}">';
                        document.getElementById('result_critical_info').innerHTML += ' Missing PoM., DL or Domain ';
                        findings++;
                        missing_critical_info = true;
                    }
                    if (results.result_estimates_resources_pom_hrs.est_pom_hrs != results.result_estimates_resources_pom_hrs.rl_pom_hrs){
                        // audit failed
                        document.getElementById('result_estimates_resources_pom_hrs').innerHTML = '<img src="{% static 'images/audit_fail.png' %}">';
                        document.getElementById('result_estimates_resources_pom_hrs').innerHTML += ' ' + results.result_estimates_resources_pom_hrs.rl_pom_hrs + ' Hrs. vs ';
                        document.getElementById('result_estimates_resources_pom_hrs').innerHTML += ' ' + results.result_estimates_resources_pom_hrs.est_pom_hrs + ' Hrs.';
                        findings++;
                    }
                    if (results.result_resources_enddated.length){
                        // audit failed
                        document.getElementById('result_resources_enddated').innerHTML = '<img style="cursor:pointer" onclick="show_offboarded(this, event)" src="{% static 'images/audit_fail.png' %}">';
                        findings++;
                        var vnid_prev = '';
                        var weeks = '';
                        var tbl = document.getElementById('offboarded_loaded_tbl');
                        for (i=0; i < results.result_resources_enddated.length; i++){
                            var rec = results.result_resources_enddated[i];
                            vnid = rec.vnid;
                            if (vnid != vnid_prev){
                                if (weeks.length){
                                    var newRow=tbl.insertRow();
                                    var cell1   = newRow.insertCell(0);
                                    var txt = weeks.slice(0, -2);
                                    var cell1Text  = document.createTextNode(txt)
                                    cell1.appendChild(cell1Text);
                                    weeks = '';
                                }

                                newRow=tbl.insertRow();
                                cell1   = newRow.insertCell(0);
                                txt = rec.first_name + ' was offboarded on ' + rec.enddate + ' but he is loaded for weeks: ';
                                cell1Text  = document.createTextNode(txt)
                                cell1.appendChild(cell1Text);
                                vnid_prev = vnid;
                            }
                            weeks += rec.week + ', ' ;

                        }
                        if (weeks.length){
                            var newRow=tbl.insertRow();
                            var cell1   = newRow.insertCell(0);
                            var txt = weeks.slice(0, -2);
                            var cell1Text  = document.createTextNode(txt)
                            cell1.appendChild(cell1Text);
                            weeks = '';
                        }
                    }
                    if (results.result_resources_overloaded.length){
                        // audit failed
                        document.getElementById('result_resources_overloaded').innerHTML = '<img style="cursor:pointer" onclick="show_overloaded(this, event)" src="{% static 'images/audit_fail.png' %}">';
                        findings++;

                        var vnid_prev = '';
                        var weeks = '';
                        var tbl = document.getElementById('overloaded_tbl');
                        for (i=0; i < results.result_resources_overloaded.length; i++){
                            var rec = results.result_resources_overloaded[i];
                            vnid = rec.vnid;
                            if (vnid != vnid_prev){
                                if (weeks.length){
                                    var newRow=tbl.insertRow();
                                    var cell1   = newRow.insertCell(0);
                                    var txt = weeks.slice(0, -2);
                                    var cell1Text  = document.createTextNode(txt)
                                    cell1.appendChild(cell1Text);
                                    weeks = '';
                                }

                                newRow=tbl.insertRow();
                                cell1   = newRow.insertCell(0);
                                txt = rec.first_name + ' is overloaded for weeks: ';
                                cell1Text  = document.createTextNode(txt)
                                cell1.appendChild(cell1Text);
                                vnid_prev = vnid;
                            }
                            weeks += rec.week + ', ' ;

                        }
                        if (weeks.length){
                            var newRow=tbl.insertRow();
                            var cell1   = newRow.insertCell(0);
                            var txt = weeks.slice(0, -2);
                            var cell1Text  = document.createTextNode(txt)
                            cell1.appendChild(cell1Text);
                            weeks = '';
                        }

                    }
                    if (results.results_racis == null){
                        // audit failed
                        document.getElementById('results_racis').innerHTML = '<img src="{% static 'images/audit_fail.png' %}">';
                        findings++;
                    }
                    $("#audit_span")[0].innerHTML='';
                    if (findings){
                        $("#audit_span")[0].innerHTML='<img style="cursor:pointer" onclick="show_findings(this, event)" src="{% static 'images/audit_fail.png' %}">';
                    }
                    else{
                        $("#audit_span")[0].innerHTML='<img src="{% static 'images/audit_ok.png' %}">';
                    }
                }
                catch(e){
                }
                },
                error: function(response) {
                console.log(response);
                }
            });
            {% endif %}

        });

        function c2c(rfs_request_id){
            navigator.clipboard.writeText('{{ request.build_absolute_uri }}'.split('?')[0] + '?rfs_request_id=' + rfs_request_id).then(() => {
        alert("successfully copied");
      })
      .catch(() => {
        alert("something went wrong");
      });
        }

    var formChanged = false;

    $(document).ready(function() {
        document.getElementById('initRFS').addEventListener('change', function(){
           formChanged = true;
        });

    });

    function show_findings(results, event){
        $("#audit_findings").show();
    }

    function show_offboarded(){
        $("#offboarded_loaded").show();
    }

    function show_overloaded(){
        $("#overloaded").show();
    }

    function show_comments(rfs_request_id, approval_num){

    }

    window.addEventListener('beforeunload', function(e){
        if (formChanged){
            var confirmMsg = "You have unsaved changes. Are you sure!";
            e.returnValue = confirmMsg;

            return confirmMsg;
        }
    });

    </script>

    <style>
        .w3-border-red, .w3-hover-border-red:hover {
            border: 4px solid #A40000;
            border-radius: 5px;
            padding-top: 5px;
            padding-right: 5px;
            padding-bottom: 5px;
            padding-left: 5px;
        }

    </style>
    <a href="{% url 'export_users_xls' %}?rfs_request_id={{rfs_request_data.link}}{% if version %}&version={{version}}{% endif %}">Export RFS in Excel</a>
    - <span style="cursor: pointer" onclick = "c2c('{{rfs_request_data.link}}');">Copy Link</span>
    <h5>{{page.name}} - <a href="/rfs/">RFS Home</a> </h5>
    <div id="myHeader">
    <div class="headernav">
        <div class="row">
            <span class="col-md-10">
                {% if rfs_request_data.rfs_request_id %}
                    <span id="audit_span"><img src="{% static 'images/audit_loading.gif' %}"></span>
                    RFS ID:
                        {{ rfs_request_data.rfs_request_id}}
                        ({{rfs_request_data.project_id}} - {{rfs_request_data.project_name}})
                {% else %}
                        Not Created
                {% endif %}
           </span>
            <span class="col-md-2">  {{ rfs_request_data.rfs_status}} </span>

        </div>
        <div class="row text-center">
            {% if version %}
                <span class="col-md-10" style="background:yellow;color:black;"> Version: {{version}}</span>
                <span class="col-md-2" >
                    <form name="rfsform" method="post" action="/rfs/request-for-service/">
                            {% csrf_token %}
                            <input type="hidden" name="rfs_request_id" value="{{rfs_request_data.link}}">
                            <input type="hidden" name="via_view" value="via_view">
                            <button class="greenbuttons" type="submit">Current RFS</button>
                        </form>
                </span>
            {% else %}
                <span class="col-md-12">
                    {% if rfs_request_data.rfs_status == '' %}
                        {% if user_access.0.rfs_edit %}
                            <button class="greenbuttons" type="button" onclick="changeStatus('NEW');" > Start RFS </button>
                        {% endif %}
                    {% endif %}
                    {% if rfs_request_data.rfs_status == 'NEW' or rfs_request_data.rfs_status == 'RETURNED' or rfs_request_data.rfs_status == 'REOPENED' %}
                        {% if user_access.0.rfs_edit %}
                            <button class="greenbuttons" type="button" onclick="changeStatus('{{rfs_request_data.rfs_status}}');"> Save RFS </button>
                            <button class="greenbuttons" type="button" onclick="changeStatus('SUBMITTED');">Submit RFS</button>
                        {% endif %}
                    {% endif %}
                    {% if rfs_request_data.rfs_request_id and rfs_request_data.rfs_status == 'SUBMITTED' %}
                        {% if user_access.0.rfs_wf and approver %}
                            <button class="greenbuttons" type="button" onclick="changeStatus('APPROVED');">Approve </button>
                            <button class="greenbuttons" type="button" onclick="changeStatus_comment('RETURNED');"> Return </button>
                        {% elif user_access.0.rfs_edit %}
                            <button class="greenbuttons" type="button" onclick="changeStatus_comment('RETURNED');"> Recall </button>
                        {% endif %}
                    {% endif %}
                    {% if rfs_request_data.rfs_status == 'APPROVED' %}
                        {% if user_access.0.rfs_wf or user_access.0.rfs_edit %}
                            <button class="greenbuttons" type="button" onclick="changeStatus_comment('REOPENED');" > Reopen RFS </button>
                        {% endif %}
                    {% endif %}
                </span>
            {% endif %}
        </div>
    </div>

    <div class="headernavblue">
        <div class="row text-center">
            {% if rfs_request_data.rfs_request_id %}
            <span class="col-md-4">
                <form name="rfsform" method="post" action="{% if version %}/rfs/request-for-service/approved{% else %}.{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="rfs_request_id" value="{{rfs_request_data.link}}">
                    <input type="hidden" name="via_view" value="via_view">
                    {% if version %}<input type="hidden" name="version" value="{{version}}">{% endif %}
                    <button class="greenbuttons" type="submit">Request For Service</button>
                </form>
            </span>
            <span class="col-md-4">
                <form name="rfsform" method="post" action="{% if version %}/rfs/request-for-service/estimates/approved{% else %}estimates{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="rfs_request_id" value="{{rfs_request_data.link}}">
                    <input type="hidden" name="via_view" value="via_view">
                    {% if version %}<input type="hidden" name="version" value="{{version}}">{% endif %}
                    <button class="greenbuttons" type="submit">Estimates</button>
                </form>
            </span>
            <span class="col-md-4">
                <form name="rfsform" method="post" action="{% if version %}/rfs/request-for-service/resource-loading/approved{% else %}resource-loading{% endif %}">
                    {% csrf_token %}
                    <input type="hidden" name="rfs_request_id" value="{{rfs_request_data.link}}">
                    <input type="hidden" name="via_view" value="via_view">
                    {% if version %}<input type="hidden" name="version" value="{{version}}">{% endif %}
                    <button class="greenbuttons" type="submit">Resource Loading</button>
                </form>
            </span>
            {% endif %}
        </div>
    </div>
    </div>

    {% block rfs_content %}
    {% endblock %}
    {% load humanize %}
    {% if approved_rfs %}
        <div class="w3-border-bottom w3-border-red">
            <span id="collapse">Approval History +/-</span>

        <div id="approvals">
            <table class="rbstable" >
                <tr>

                    <th>
                        Approval Date
                    </th>
                    <th>
                        Total QA Hrs
                    </th>
                    <th colspan="2">
                        Total QA Cost
                    </th>
                </tr>
            {% for rfs in approved_rfs %}
                <tr>

                    <td>
                        {{rfs.approval_date|date:"d-M-Y"}}
                    </td>
                    <td>
                        {{rfs.rfs_total_hrs|default_if_none:"0"|intcomma}}
                    </td>
                    <td>
                        ${{rfs.total_qa_cost|default_if_none:"0"|intcomma}}
                    </td>
                    <td>
                        <form method="post" action="./approved">
                            {% csrf_token %}
                            <button type="submit" class="greenbuttons" value="View">View Version {{rfs.approval_num}}</button>
                            <input type="hidden" name="rfs_request_id" value="{{rfs.link}}">
                            <input type="hidden" name="version" value="{{rfs.approval_num}}">
                        </form>
                    </td>
                </tr>
            {% endfor%}
            </table>
            <span id="collapse_history" onclick="$('#div_history').slideToggle('slow')" style="cursor:pointer">Detailed History</span>
            <div id="div_history" style="display:none;">
                <table class="rbstable" id="tbl_history">
                    <thead>
                    <tr>
                        <th>S.No.</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Changed By</th>
                        <th>Comments</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for rec in history %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{rec.created|date:"d-M-Y"}}</td>
                            <td>{{rec.rfs_status}}</td>
                            <td>{{rec.first_name}} {{rec.last_name}}</td>
                            <td>{{rec.comments}}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
         </div>

    {% endif %}
    <div id="audit_findings" class="audit">
        <table class="rbstable rbstables">
            <tr>
                <td colspan="2">
                    <table width="100%">
                        <tr>
                            <th width="95%" style="text-align:center">Audit Findings for {{rfs_request_data.project_id}} - {{rfs_request_data.project_name}}</th>
                            <th style="text-align:right"><span style="color:black; cursor:pointer;" onclick="$('#audit_findings').hide()"> X </span></th>
                        </tr>
                    </table>
                </td>

            </tr>
            <tr>
                <td width="50%">Critical Info</td>
                <td width="50%" id="result_critical_info"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
            <tr>
                <td width="50%">Resource Loading vs Estimates Total Hrs</td>
                <td width="50%" id="result_estimates_resources_hrs"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
            <tr>
                <td>Resource Loading vs Estimates PoM Hrs</td>
                <td id="result_estimates_resources_pom_hrs"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
            <tr>
                <td>Offboarded Resources Loaded</td>
                <td id="result_resources_enddated"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
            <tr>
                <td>Resources Overloaded</td>
                <td id="result_resources_overloaded"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
            <tr>
                <td>No RACIs</td>
                <td id="results_racis"><img src="{% static 'images/audit_ok.png' %}"></td>
            </tr>
        </table>
    </div>

    <div id="offboarded_loaded" class="audit">
        <table class="rbstable rbstables" id="offboarded_loaded_tbl">
            <tr>
                <td colspan="2">
                    <table width="100%">
                        <tr>
                            <th width="95%" style="text-align:center">Offboarded Resources Loaded</th>
                            <th style="text-align:right"><span style="color:black; cursor:pointer;" onclick="$('#offboarded_loaded').hide()"> X </span></th>
                        </tr>
                    </table>
                </td>
            </tr>

        </table>
    </div>

    <div id="overloaded" class="audit">
        <table class="rbstable rbstables" id="overloaded_tbl">
            <tr>
                <td colspan="2">
                    <table width="100%">
                        <tr>
                            <th width="95%" style="text-align:center">Overloaded Resources</th>
                            <th style="text-align:right"><span style="color:black; cursor:pointer;" onclick="$('#overloaded').hide()"> X </span></th>
                        </tr>
                    </table>
                </td>
            </tr>

        </table>
    </div>

    <div id="comment_div" class="audit">
        <table class="rbstable rbstables" id="comment_tbl">
            <tr>
                <td colspan="2">
                    <table width="100%">
                        <tr>
                            <th width="95%" style="text-align:center">Add Comments</th>
                            <th style="text-align:right"><span style="color:black; cursor:pointer;" onclick="$('#comment_div').hide()"> X </span></th>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <textarea id="comment_text" rows="4" cols="30"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <button class="greenbuttons" onclick="updateComment()">Proceed</button>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>

        </table>
    </div>
    <div style="height:500px"></div>
{% endblock %}
