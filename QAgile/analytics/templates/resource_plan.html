{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'js/ion.rangeSlider-master/css/ion.rangeSlider.min.css' %}" >
<script type="text/javascript" src="{% static 'js/ion.rangeSlider-master/js/ion.rangeSlider.js' %}" type="javascript"></script>
<link rel="stylesheet" type="text/css" href="{% static 'js/Chart.js/Chart.css' %}" >
<script type="text/javascript" src="{% static 'js/Chart.js/Chart.js' %}" type="javascript"></script>


<script language="JavaScript">
    var person_domain = [];
    var loopcnt = 0;

    {% for row in person_domain %}
        person_domain.push({'domain_id': '{{row.domain_id}}', 'vnid':'{{row.vnid}}'});
    {% endfor %}


    function trigger_ds(isSelected, domain_id){
        arr_selected_domains = $('#domainselect').val();
        if (arr_selected_domains.length){
            $('#personselect').selectpicker('val','');
            $('#personselect').find('*').hide();
        }
        else{
            $('#personselect').find('*').show();
        }
        for(var i=0; i<arr_selected_domains.length; i++){
            let vnids = get_vnids_by_domain(arr_selected_domains[i]);
            for (var j=0 ; j<vnids.length; j++){
                $('#personselect').find('[value=' + vnids[j] + ']').show()

            }
        }
        $('#personselect').selectpicker('refresh');
    }

    function get_vnids_by_domain(domain_id){
        let vnids = []
        for (i=0; i < person_domain.length; i++){
            if(person_domain[i].domain_id == domain_id) vnids.push(person_domain[i].vnid);
        }
        return vnids;
    }


    $(document).ready(function(){

        {% if filters.domains %}
            $('#domainselect').selectpicker('val',{{filters.domains|safe|escape}});
        {% endif %}

        {% if filters.vnids %}
            $('#personselect').selectpicker('val',{{filters.vnids|safe|escape}});
        {% endif %}

        {% if filters.vnids %}
            $('#personselect').selectpicker('val',{{filters.vnids|safe|escape}});
        {% endif %}

        $('#domainselect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                trigger_ds(isSelected, e.target[clickedIndex].value);
        });
    });



</script>
<h5><a href="/analytics/">Analytics Home</a></h5>
<h3 style="color:black"><a href="/analytics/resource-plan"> Resource Plan</a></h3>
<form method="get">
    {% csrf_token %}
    <table class="rbstable">
        <tr>

             <td>
                Include Planned <input type="checkbox" name="plan_select" {% if filters.plan == 'on' %}checked {% endif %}>
            </td>

            <td>
                Domains
                <select id="domainselect" name="domain_ids" class="selectpicker" multiple data-live-search="true">
                    {% for row_d in domains_info %}
                        <option value="{{row_d.domain_id}}">{{row_d.domain_name}}</option>
                    {% endfor   %}
                </select>
            </td>

            <td>
                Resources
                <select id="personselect" name="vnids" class="selectpicker" multiple data-live-search="true" data-actions-box="true">

                    {% for row_d in persons %}
                        <option value="{{row_d.vnid}}" data-tokens="{{row_d.vnid}},{{row_d.domain_name}},{{row_d.role}}">{{row_d.first_name}} {{row_d.last_name}}</option>
                    {% endfor   %}
                </select>
            </td>

        </tr>
        <tr>
            <td colspan="4">
                <input type="text" class="js-range-slider" name="dt_range" id="dt_range" value="" />
            </td>
        </tr>
        <tr>
            <td colspan="4">
                <input type="submit" class="greenbuttons" style="width: 100%;"  value="Let's Roll" />
            </td>
        </tr>

    </table>
</form>

{% if chartdata %}
    <script>
        const months = [
          'Jan',
          'Feb',
          'Mar',
          'Apr',
          'May',
          'Jun',
          'Jul',
          'Aug',
          'Sep',
          'Oct',
          'Nov',
          'Dec'
        ];

        multperson = [];
        persons = {{persons|safe|escape}};
        weekStart = startOfWeek(new Date());
        v_numofweeks = 0;
        fixedCols = 6;

        function addWeeks(n){


            headcolcount = $("#loadTable")[0].rows[0].cells.length;
            weekcols = headcolcount - fixedCols;

            for(i=0; i<n; i++){
                pos = $("#loadTable").find("tr:first th").length-1;
                tmpweekstart=new Date(weekStart.getTime());
                weekstartdt = formatDate( tmpweekstart.setDate(tmpweekstart.getDate()+(weekcols+i)*7) );
                humandate = formatDateHuman( tmpweekstart );
                $('#loadTable').find('tr').each(function(a,b){
                    var vnid = this.id;

                    var td_name = "f_week_hrs_"+vnid+"_"+weekstartdt;
                    var controls = "";

                    $(this).find('th').eq(pos).after('<th style="font-size:small;text-align:center;min-width:100px;">'+humandate+'</th>');
                    $(this).find('td').eq(pos).after("<td style='font-size:small'><span type='text' name='"+td_name+"'  width='50px'>"+controls+"</td>");
                });
            }
        }

    function deleteWeeks(n){
        for(i=0; i<n; i++){
            pos = $("#loadTable").find("tr:first th").length;
            if(pos < (fixedCols + 1)) return;
            $('#loadTable th:nth-child('+pos+'),#loadTable td:nth-child('+pos+')').remove();
        }
    }


    function manageWeeks(){

        v_numofweeks_changed_to = $("#replyNumber").val();
        diff = v_numofweeks_changed_to - v_numofweeks;

        if(diff > 0){
            console.log("add " + diff + " new columns");
            addWeeks(diff);
        }
        else if (diff < 0){
            console.log("delete " + diff*(-1) + " columns");
            deleteWeeks(diff*(-1));
        }
        else {
            alert("How did this happen?!?");
        }

        v_numofweeks = v_numofweeks_changed_to;

    }

    function startOfWeek(date){

        var diff = date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1);
        return new Date(date.setDate(diff));

    }

    function setWeekStart(){

        if( ! isNaN(Date.parse(new Date($('#weekstart').val()))) ){ //only if date UI field has valid date
            weekStart = startOfWeek( new Date($('#weekstart').val().replace(/-/g,"/")) );
        }
    }

    function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2)
            month = '0' + month;
        if (day.length < 2)
            day = '0' + day;

        return [year, month, day].join('-');
    }

    function formatDateHuman(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2)
            month = '0' + month;
        if (day.length < 2)
            day = '0' + day;

        return [day,  months[d.getMonth()], d.getFullYear()%100].join('-');
    }

    </script>

    <script>

        function do_toggle(vnid){
            $(".fold_"+vnid).slideToggle(50);
        }

        slidetog = 0;
        function toggleAll(){
            if(slidetog){
                $('*[class^="fold_"]').slideUp("slow");
                slidetog = 0;
            }
            else{
                $('*[class^="fold_"]').slideDown("slow");
                slidetog = 1;
            }

        }

        $(document).ready(function() {

            try {
                datestring = weekStart.getFullYear() + "-" +("0" + (weekStart.getMonth()+1)).slice(-2) + "-" + ("0"+(weekStart.getDate())).slice(-2);
                $('#weekstart').val(datestring)
            }
            catch(e) {}

            /* ******************************************* PRE POPULATE Start*********************************************
               ******************************************* PRE POPULATE *********************************************
               ******************************************* PRE POPULATE *********************************************
            */
            v_numofweeks = '{{datahead.numofweeks}}';
            prev_domain = '';
            prev_name='';
            {% for row in static_tbl %}
                multperson.push('{{row.person_id}}');
                    var value = '{{row.person_id}}_{{row.project_id}}';
                    var record = {};

                    record.first_name = '{{row.name}}';
                    record.domain_name = '{{row.domain_name}}';
                    if(record.first_name == prev_name) record.first_name = '';
                    if(record.domain_name == prev_domain) record.domain_name = '';
                    prev_domain = '{{row.domain_name}}';
                    prev_name='{{row.name}}';
                    record.role = '{{row.role}}';
                    record.rate = '{{row.rate}}';
                    record.project_id = '{{row.project_id}}';


                    addXtraRow="";
                    colspan="";
                    if (record.first_name.length) {
                        addXtraRow = "</tr><tr id='"+value+"' class='fold_{{row.person_id}}'  style='display:none'><td><input type='text' style='font-size:x-small;border: 0px;background: transparent;' value='{{row.project_name}}'></td>";
                        markuptropen = "<tr onclick='do_toggle(\"{{row.person_id}}\");' id='head_{{row.person_id}}'>";
                        colspan = 2;
                    }
                    else{
                        markuptropen = "<tr id='"+value+"' class='fold_{{row.person_id}}' style='display:none'>";
                        colspan = 1;
                        record.first_name = "<input type='text' style='font-size:x-small;border: 0px;background: transparent;' value='{{row.project_name}}'>";
                    }
                    markupTDData = "<td colspan = '"+colspan+"' style='cursor: pointer'>"+record.first_name+"</td>"+addXtraRow+"<td><a href='../../rfs/request-for-service/resource-loading?rfs_request_id={{row.link}}' target='_blank'>"+record.project_id+"</a></td><td style='display:none'>"+record.role+"</td><td  style='display:none' id='rate_"+value+"'>"+record.rate+"</td><td style='display:none'><span id='total_hrs_"+value+"'></span></td><td style='display:none'><span id='qa_cost_"+value+"'></span></td>";
                    var controls = "";
                    //console.log(markupTDData);
                    markupExtraTd = '';
                    markuptrclose= "</tr>";
                    markup = markuptropen + markupTDData + markupExtraTd + markuptrclose;
                    $("#loadTable tbody").append(markup);
            {% endfor %}


            var ws = '{{datahead.weekstart}}';
            weekStart = new Date(ws.split('-')[0], (ws.split('-')[1]-1), ws.split('-')[2]);
            $("#weekstart").val(ws);


            addWeeks({{datahead.numofweeks}});

            {% for row in chartdata %}
                hrs = "{{row.hrs}}";
                //console.log("{{row}}");
                if (hrs == "None") hrs = "";
                try {
                $("[name='f_week_hrs_{{row.person_id}}_{{row.project_id}}_{{row.week}}']")[0].innerHTML = encodeURIComponent(hrs);
                }
                catch(e){}
            {% endfor %}

            $('#resSelect').selectpicker('val', multperson);
            $('#resSelect').selectpicker('refresh');


            //refreshCosts(multperson);
                monitor_loop = 0
                $("[id^='head_']").each(function(a,b){
                    var vnid = this.id.split("_")[1];
                    if(vnid == 'vn05672'){
                        console.log("start debuf");
                    }
                    for(var i=0; i<v_numofweeks; i++){
                        var x = this.insertCell(-1);
                        next = $("[name^='f_week_hrs_"+vnid+"']").length/v_numofweeks;
                        var sum = 0;
                        nextRow = this.nextSibling;
                        for(var j =0; j<next; j++){
                            try{
                                hr = nextRow.cells[x.cellIndex+5].firstChild.innerHTML;
                                if(isNaN(parseFloat(hr))) hr=0;
                                sum = parseFloat(sum)+parseFloat(hr);
                                nextRow = nextRow.nextSibling;
                            }catch(e){}
                        }
                        x.innerHTML=encodeURIComponent(sum);
                    }
                });





            /* ******************************************* PRE POPULATE End*********************************************
               ******************************************* PRE POPULATE *********************************************
               ******************************************* PRE POPULATE *********************************************
            */


        } );



    </script>


    <div class="contentnav overflow-auto" style="min-height:400px;">
        <form name="initRFS" id="initRFS" method="post" action="./resource-loading">

        <div>
            <span style="cursor:pointer" onclick="toggleAll()">+/-</span>
            <table border="1" id="loadTable" class="rfstables">
                <thead>
                <tr>

                    <th style="max-width:75px; min-width:75px;font-size:small">Name</th>
                    <th style="max-width:150px; min-width:150px;font-size:small">Project</th>
                    <th style="display:none;max-width:150px; min-width:150px;font-size:small">Role</th>
                    <th style="display:none; max-width:100px; min-width:100px;font-size:small">Rate</th>
                    <th style="display:none;max-width:75px; min-width:75px;font-size:small">Total Hrs.</th>
                    <th style="display:none;max-width:75px; min-width:75px;font-size:small">QA $</th>
                </tr>
                </thead>
            <tbody>
            </tbody>
            </table>

        </div>
        </form>
    </div>

{% endif %}

<script>
    var myChart;
    $(document).ready(function(){
        var lang = "en-US";
        var d = new Date;
        var year = d.getFullYear();
        var month = d.getMonth();
        var day = d.getDate();

        function dateToTS (date) {
            return date.valueOf();
        }

        function tsToDate (ts) {
            var d = new Date(ts);

            return d.toLocaleDateString(lang, {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        }

        $("#dt_range").ionRangeSlider({
            skin: "big",
            type: "double",
            grid: true,
            min: dateToTS(new Date(year, month-6, day)),
            max: dateToTS(new Date(year, month+12, day)),
            from: dateToTS(new Date(year, month, day-7)),
            to: dateToTS(new Date(year, month+8, day)),
            prettify: tsToDate
        });

        let my_range = $("#dt_range").data("ionRangeSlider")
        {% if filters.dt_range %}
            my_range.update({
                from: {{filters.dt_range.0}},
                to: {{filters.dt_range.1}}
            });
        {% endif %}

        $("#line").click(function() {
          change('line');
        });

        $("#bar").click(function() {
          change('bar');
        });

        function change(newType) {
          var ctx = document.getElementById("myChart").getContext("2d");

          // Remove the old chart and all its event handles
          if (myChart) {
            myChart.destroy();
          }

          // Chart.js modifies the object you pass in. Pass a copy of the object so we can use the original object later
        if(newType == 'line')
            var temp = jQuery.extend(true, {}, config_c);
        else
            var temp = jQuery.extend(true, {}, config);
          temp.type = newType;
          myChart = new Chart(ctx, temp);
          window.scrollTo(0,document.body.scrollHeight);
        };
    });
</script>
{% endblock %}